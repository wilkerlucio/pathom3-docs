<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.64">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GZFCYV0DXN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GZFCYV0DXN",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Pathom 3" href="/opensearch.xml"><title data-react-helmet="true">Hacker News Scraper | Pathom 3</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Hacker News Scraper | Pathom 3"><meta data-react-helmet="true" name="description" content="In this tutorial, we are going to write a scraper to extract information from hacker"><meta data-react-helmet="true" property="og:description" content="In this tutorial, we are going to write a scraper to extract information from hacker"><meta data-react-helmet="true" property="og:url" content="https://pathom3.wsscode.com/docs/tutorials/hacker-news-scraper"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://pathom3.wsscode.com/docs/tutorials/hacker-news-scraper"><link rel="stylesheet" href="/styles.4444d5c6.css">
<link rel="preload" href="/styles.7bd4c1d1.js" as="script">
<link rel="preload" href="/runtime~main.06d5458d.js" as="script">
<link rel="preload" href="/main.b951b7af.js" as="script">
<link rel="preload" href="/1.2e2774a7.js" as="script">
<link rel="preload" href="/2.8a5fdb16.js" as="script">
<link rel="preload" href="/3.c43cf402.js" as="script">
<link rel="preload" href="/1be78505.9817f03c.js" as="script">
<link rel="preload" href="/43.d6df2bea.js" as="script">
<link rel="preload" href="/935f2afb.736e8c56.js" as="script">
<link rel="preload" href="/17896441.01d25d16.js" as="script">
<link rel="preload" href="/e6b7f731.69429666.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/icon_64x64.png" alt="Pathom 3"><strong class="navbar__title">Pathom 3</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://blog.wsscode.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a class="navbar__item navbar__link" href="/media">Media</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wilkerlucio/pathom3" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/icon_64x64.png" alt="Pathom 3"><strong class="navbar__title">Pathom 3</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://blog.wsscode.com" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/media">Media</a></li><li class="menu__list-item"><a href="https://github.com/wilkerlucio/pathom3" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/tutorial">Pathom Tutorial</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Using Pathom</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/resolvers">Resolvers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/built-in-resolvers">Built-in Resolvers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/smart-maps">Smart Maps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/eql">EQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/environment">Environment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cache">Cache</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/placeholders">Placeholders</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mutations">Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/error-handling">Error Handling</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/plugins">Plugins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/built-in-plugins">Built-in Plugins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/async">Async</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/debugging">Debugging</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How Pathom Works</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/indexes">Indexes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/planner">Planner</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/shape-descriptor">Shape Descriptor</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/tutorials/hacker-news-scraper">Hacker News Scraper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/serverless-pathom-gcf">Serverless Pathom with GCF</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/babashka">Scripting with Babashka</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Hacker News Scraper</h1></header><div class="markdown"><p>In this tutorial, we are going to write a scraper to extract information from hacker
news pages using Pathom.</p><p>Pathom enables declarative programming for data processing.</p><p>Using Pathom, we will map out the data from Hacker News in attributes, and then we use
this mapping in various ways to query information.</p><p>This scraper will be capable of:</p><ul><li>Listing hacker news pages: news, past, ask</li><li>Read user data</li><li>Read comments from items</li><li>Navigate on pagination</li></ul><p>Let&#x27;s start!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="attribute-mapping"></a>Attribute mapping<a aria-hidden="true" tabindex="-1" class="hash-link" href="#attribute-mapping" title="Direct link to heading">#</a></h2><p>The first step is to make names for every attribute we want to handle.</p><p>Here is a quick guide you can follow to help in this process:</p><ol><li>Pick a general prefix, usually the product/service name. For this case, I&#x27;ll pick: <code>hacker-news</code>.</li><li>For data points, add some entity context in the name. In the case of Hacker News, I see they call it <code>item</code>.</li><li>If you mean to read collections, give each collection a name.</li></ol><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If you are developing a product for a company, use the company name for step one.
Avoid having short names like <code>:user/name</code> since they have a higher collision chance.
This makes your names much harder to integrate with other names.</p></div></div><p>Let&#x27;s see what are the interesting data points to extract from the Hacker News front
page:</p><div class="pathom-diagram"><p>  <img alt="Front Page Mapping" src="/assets/images/front-page-mapping-d5349096bcb336297a94210c1ff2a0d9.png"></p></div><p>The circle cursors point to visible points of data. The open diamond means the data
is hidden (inside the markup).</p><p>I used the name <code>:hacker-news.page/news</code> to name the collection of items for this page.</p><p>Here is a text version of all the declared attributes:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; item attributes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.item/url</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; news collection</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">:hacker-news.page/news</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="reading-the-news-page"></a>Reading the news page<a aria-hidden="true" tabindex="-1" class="hash-link" href="#reading-the-news-page" title="Direct link to heading">#</a></h2><p>For the implementation, I&#x27;ll use the <a href="https://github.com/davidsantiago/hickory" target="_blank" rel="noopener noreferrer">Hickory</a> library to parse the HTML and extract
the data.</p><p>To start, we need to explore and figure the code to extract the information fragments
from the HTML page.</p><p>I like to start reading the raw HTML and saving it on a <code>defonce</code>, so I can keep reloading
the REPL while has a cached version of sample data:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(ns com.wsscode.pathom3.docs.demos.tutorials.hacker-news-scrapper)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defonce sample-html (slurp (str &quot;https://news.ycombinator.com/news&quot;)))</span></div></div></div></div></div><p>It&#x27;s time to learn about the HTML structure of Hacker News page. I like to use the
Chrome inspector to navigate. I can see there is a table with the class <code>itemlist</code>
wrapping the item elements.</p><div class="pathom-diagram"><p>  <img alt="Front Page Mapping" src="/assets/images/inspect-container-649f80cfd60a317b395eb5fbacdd95cb.png"></p></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="finding-the-items"></a>Finding the items<a aria-hidden="true" tabindex="-1" class="hash-link" href="#finding-the-items" title="Direct link to heading">#</a></h3><p>I&#x27;ll start this query using our data and Hickory and try it on the REPL, I suggest
you follow along in your REPL:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(ns com.wsscode.pathom3.docs.demos.tutorials.hacker-news-scrapper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (:require [hickory.core :as hc]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            [hickory.select :as hs]))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defonce sample-html (slurp (str &quot;https://news.ycombinator.com/news&quot;)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; navigate to table element</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; sample-html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/parse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/as-hickory)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       first))</span></div></div></div></div></div><p>Now we can extract the rows out. Hacker News doesn&#x27;t make it straight forward. When I
look at the rows, I see each item uses two table rows. Then it has a spacer row between
the next two with the class <code>spacer</code>. To add more details, there is a
different row with the class <code>morespace</code> in the end.</p><p>To deal with this, we are going to query for rows, removing the ones with the class <code>spacer</code>
or <code>morespace</code>.</p><p>This is how we can do it with Hickory:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; sample-html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/parse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/as-hickory)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hs/select (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    (hs/not (hs/or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              (hs/class &quot;spacer&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              (hs/class &quot;morespace&quot;)))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (partition 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (mapv #(hash-map :type :element :tag :tbody :content (vec %)))))</span></div></div></div></div></div><p>Now we have a collection where each item represents a row in Hacker News.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>After the <code>partition</code> the <code>mapv</code> is making a fake element for Hickory, this way we
can threat the two rows as a single element for querying in.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="read-item-details"></a>Read item details<a aria-hidden="true" tabindex="-1" class="hash-link" href="#read-item-details" title="Direct link to heading">#</a></h3><p>Now for each item, we need to extract the attributes we want. Here are a few helpers
we will use for it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn find-text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Given an element, traverse the contents until it reaches some text.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (loop [item (first (:content el))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (if (string? item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (if-let [next (some-&gt; item :content first)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (recur next)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nil))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn class-text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Get the text for a given element that matches a css class.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [el class]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; (hs/select (hs/class class) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (find-text)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn select-number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Extract the first integer from a string.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [x]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (if-let [[_ n] (re-find #&quot;(\d+)&quot; (str x))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (Integer/parseInt n)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    0))</span></div></div></div></div></div><p>Here is a function to extract the data points we mentioned at start from each item:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn extract-item-from-hickory [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.item/age            (class-text el &quot;age&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/author-name    (class-text el &quot;hnuser&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/comments-count (-&gt;&gt; (hs/select (hs/find-in-text #&quot;comments$&quot;) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         (find-text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         (select-number))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/score          (select-number (class-text el &quot;score&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/id             (-&gt;&gt; el :content first :attrs :id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/rank-in-page   (select-number (class-text el &quot;rank&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/source         (class-text el &quot;sitestr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/title          (class-text el &quot;storylink&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/url            (-&gt;&gt; (hs/select (hs/class &quot;storylink&quot;) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         first :attrs :href)})</span></div></div></div></div></div><p>Let&#x27;s use it to extract the data from our previous process:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; sample-html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/parse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/as-hickory)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hs/select (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    (hs/not (hs/or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              (hs/class &quot;spacer&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              (hs/class &quot;morespace&quot;)))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (partition 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (mapv #(hash-map :type :element :tag :tbody :content (vec %)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (mapv extract-item-from-hickory)))</span></div></div></div></div></div><p>Now you should see the nice plain data in the output, with one map for each
item entry.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="make-a-resolver"></a>Make a resolver<a aria-hidden="true" tabindex="-1" class="hash-link" href="#make-a-resolver" title="Direct link to heading">#</a></h2><p>Time to introduce Pathom, now I&#x27;m going to turn that exploration code in a resolver:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(ns com.wsscode.pathom3.docs.demos.tutorials.hacker-news-scrapper</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  (:require [com.wsscode.pathom3.connect.indexes :as pci]</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            [com.wsscode.pathom3.connect.operation :as pco]</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            [com.wsscode.pathom3.interface.eql :as p.eql]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            [hickory.core :as hc]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            [hickory.select :as hs]))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn find-text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Given an element, traverse the contents until it reaches some text.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (loop [item (first (:content el))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (if (string? item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (if-let [next (some-&gt; item :content first)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (recur next)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nil))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn class-text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Get the text for a given element that matches a css class.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [el class]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; (hs/select (hs/class class) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (find-text)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn select-number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Extract the first integer from a string.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [x]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (if-let [[_ n] (re-find #&quot;(\d+)&quot; (str x))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (Integer/parseInt n)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    0))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn extract-item-from-hickory [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.item/age            (class-text el &quot;age&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/author-name    (class-text el &quot;hnuser&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/comments-count (-&gt;&gt; (hs/select (hs/find-in-text #&quot;comments$&quot;) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         (find-text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         (select-number))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/score          (select-number (class-text el &quot;score&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/id             (-&gt;&gt; el :content first :attrs :id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/rank-in-page   (select-number (class-text el &quot;rank&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/source         (class-text el &quot;sitestr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/title          (class-text el &quot;storylink&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.item/url            (-&gt;&gt; (hs/select (hs/class &quot;storylink&quot;) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         first :attrs :href)})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page-html-string []</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news-raw-html</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">   (slurp &quot;https://news.ycombinator.com/news&quot;)})</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page [{:hacker-news.page/keys [news-raw-html]}]</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/news</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.item/age</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/author-name</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/id</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/comments-count</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/score</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/rank-in-page</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/source</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/title</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/url]}]}</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; news-raw-html</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (hc/parse)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (hc/as-hickory)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        first</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (hs/select (hs/and</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                     (hs/tag &quot;tr&quot;)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                     (hs/not (hs/or</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                               (hs/class &quot;spacer&quot;)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                               (hs/class &quot;morespace&quot;)))))</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (partition 2)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (mapv #(hash-map :type :element :tag :tbody :content (vec %)))</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        (mapv extract-item-from-hickory))})</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  (pci/register</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    [news-page-html-string</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">     news-page]))</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  ; get the title of all the news</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.page/news</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.item/title]}]))</span></div></div></div></div></div><p>Not much yet, but we gained the ability to filter pieces of the results.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Some editors like <a href="https://cursive-ide.com/" target="_blank" rel="noopener noreferrer">Cursive</a> do highlight keywords when your
cursor is over them. You can use this indication to see the inputs connecting with
outputs in the editor.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="caching-the-request-for-development"></a>Caching the request for development<a aria-hidden="true" tabindex="-1" class="hash-link" href="#caching-the-request-for-development" title="Direct link to heading">#</a></h3><p>When we run the process now, it requests hacker news every time. For development
it&#x27;s useful if we can cache that to have a faster iteration.</p><p>You may have noticed I used a separated resolver to fetch the HTML string. We can make
this resolver use a durable cache to speed up the iteration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page-html-string []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; define a custom cache store for this resolver</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/cache-store ::durable-cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news-raw-html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (slurp &quot;https://news.ycombinator.com/news&quot;)})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; defonce to have a durable cache, an atom with a map is a valid empty cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defonce cache* (atom {}))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; add our cache to the environment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; {::durable-cache* cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (pci/register</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [news-page-html-string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page])))</span></div></div></div></div></div><p>Now, if you keep running that expression, it only does the IO on the first time.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>To clear the cache, run <code>(reset! cache* {})</code> in the REPL.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="traversing-pagination"></a>Traversing pagination<a aria-hidden="true" tabindex="-1" class="hash-link" href="#traversing-pagination" title="Direct link to heading">#</a></h2><p>So far, we only read the first page of the news, but there is a <code>More</code> button at the
end. Now we are going to scan through these pages.</p><p>First we need to adapt the resolver that loads the page html to accept a custom URL
for it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page-html-string [{:hacker-news.page/keys [news-page-url]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/cache-store ::durable-cache*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   ::pco/input       [(pco/? :hacker-news.page/news-page-url)]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news-raw-html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (slurp (or news-page-url &quot;https://news.ycombinator.com/news&quot;))})</span></div></div></div></div></div><p>I used an <a href="/docs/resolvers#optional-inputs">optional input</a> named <code>:hacker-news.page/news-page-url</code> to allow the
customization, but still have a default.</p><p>To provide the data with the URL for the next page, I&#x27;ll add a new resolver. This resolver
will expose the attribute <code>:hacker-news.page/news-next-page</code> that contains the key
<code>:hacker-news.page/news-page-url</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-next-page [{:hacker-news.page/keys [news-raw-html]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.page/news-page-url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (let [link (some-&gt;&gt; news-raw-html hc/parse hc/as-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               (hs/select (hs/class &quot;morelink&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               first :attrs :href)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (if link</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {:hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {:hacker-news.page/news-page-url</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (str &quot;https://news.ycombinator.com/&quot; link)}})))</span></div></div></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>You can look at this resolver as an implementation of a linked list. The attribute
<code>:hacker-news.page/news-next-page</code> is a link to the next page item. In terms of Pathom,
we make that happen by providing the <code>:hacker-news.page/news-page-url</code> in that context, which can navigate
to the next <code>:hacker-news.page/news-next-page</code> and so on...</p></div></div><p>I check if there is a <code>More</code> link. Otherwise, we don&#x27;t return any data to tell Pathom
this is unavailable.</p><p>You may notice we now have two resolvers that get the HTML string for the news page
and parse it. Each resolver is doing its parsing. We can make them share this
by breaking this step into a new resolver.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">; get the html string and compute hickory</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page-hickory [{:hacker-news.page/keys [news-raw-html]}]</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news-hickory</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">   (-&gt; news-raw-html</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">       (hc/parse)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">       (hc/as-hickory))})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">; news page now uses the hickory</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-page [{:hacker-news.page/keys [news-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; news-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (hs/select (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (hs/not (hs/or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               (hs/class &quot;spacer&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               (hs/class &quot;morespace&quot;)))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (partition 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (mapv #(hash-map :type :element :tag :tbody :content (vec %)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (mapv extract-item-from-hickory))})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">; same for next page</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver news-next-page [{:hacker-news.page/keys [news-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.page/news-page-url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (let [link (some-&gt;&gt; news-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               (hs/select (hs/class &quot;morelink&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               first :attrs :href)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (if link</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {:hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {:hacker-news.page/news-page-url</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (str &quot;https://news.ycombinator.com/&quot; link)}})))</span></div></div></div></div></div><p>This is a crucial design choice when you write Pathom resolvers. How much you want
to break, as you add more resolvers, you expand the connection points to other resolvers.</p><p>In general, it is a good practice to keep spread, but it&#x27;s fine to provide many items
in a resolver when they share a close process. This reduces the amount of work Pathom
has to do to integrate.</p><p>Let&#x27;s play with our new resolvers:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; remember to update env to include all resolvers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; {::durable-cache* cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (pci/register</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [news-page-html-string</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         news-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         news-next-page])))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; get titles from first and second page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.item/title]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     {:hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [:hacker-news.item/title]}]}]))</span></div></div></div></div></div><p>Notice the query inside <code>:hacker-news.page/news-next-page</code> is the same used in the
parent query. For this we can use recursive queries, let&#x27;s say we want to pull the
next three pages:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.item/title]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     ; recurse bounded to 3 steps</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     {:hacker-news.page/news-next-page 3}]))</span></div></div></div></div></div><p>How cool is that?! You may be saying now: ok, but that&#x27;s a weird tree output.</p><p>To flat the items out we can use <code>tree-seq</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           [:hacker-news.item/title]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ; recurse bounded to 3 steps</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          {:hacker-news.page/news-next-page 3}])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (tree-seq :hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         ; we need vector at the end because tree-seq expects children to be a collection</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (comp vector :hacker-news.page/news-next-page))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       ; mapcat the news to have a single flat list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (into [] (mapcat :hacker-news.page/news))))</span></div></div></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Recursive queries can be numbers (bounded) or a symbol ... (unbounded). If you use the
unbounded, it will pull pages until Hacker News is over with them. During the time
I tested there were 21 pages. If you try, it may take some time to finish.</p></div></div><p>Pathom also supports <a href="/docs/resolvers#nested-inputs">nested inputs</a>, this means we can create a resolver to make that
same process we did with the query before:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver all-news-pages [input]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/input  [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/url]}</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                 ; note the recursive query here</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">                 {:hacker-news.page/news-next-page &#x27;...}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   ::pco/output [{:hacker-news.page/news-all-pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.item/url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/news-all-pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (tree-seq :hacker-news.page/news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (comp vector :hacker-news.page/news-next-page))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (into [] (mapcat :hacker-news.page/news)))})</span></div></div></div></div></div><p>Now we can, for example, make this query to read all titles in news, in all pages:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; this can take a while</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         [{:hacker-news.page/news-all-pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           [:hacker-news.item/title]}])))</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="read-user-data"></a>Read user data<a aria-hidden="true" tabindex="-1" class="hash-link" href="#read-user-data" title="Direct link to heading">#</a></h2><p>Let&#x27;s look at the user page this time:</p><div class="pathom-diagram"><p>  <img alt="User Page Mapping" src="/assets/images/user-page-mapping-3391c9719602dcc5e58a29782de36eeb.png"></p></div><p>Similar to before, but this time we require some user id to load the page. The arrows
show that the same attribute we read on the page as <code>:hacker-news.user/id</code> is used
in the URL to load the page.</p><p>Here are the resolvers to parse this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver user-data-hickory [{:keys [hacker-news.user/id]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; also use the durable cache here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/cache-store ::durable-cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/user-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (some-&gt; (slurp (str &quot;https://news.ycombinator.com/user?id=&quot; id))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     hc/parse hc/as-hickory)})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver user-data [{:hacker-news.page/keys [user-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.user/karma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; user-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (hs/select</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            (hs/has-child (hs/find-in-text #&quot;karma:&quot;))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        first :content second :content select-number)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.user/join-date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (let [str (-&gt;&gt; user-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  (hs/select</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      (hs/has-child (hs/find-in-text #&quot;created:&quot;))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  first :content second :content first :attrs :href)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         [_ date] (re-find #&quot;(\d{4}-\d{2}-\d{2})&quot; str)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     date)})</span></div></div></div></div></div><p>Note we also use the durable cache, so we can keep playing it. When I created this I
was hitting the same cache entry until I got the extraction code right.</p><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>You may have noticed that we now have two different attributes that mean user id.
We have <code>:hacker-news.item/author-name</code> and now <code>:hacker-news.user/id</code>. If we try to load the karma for the user in the HN item, it won&#x27;t be able to get there.</p><p>One idea is to change our previous resolver and rename <code>:hacker-news.item/author-name</code>
to <code>:hacker-news.user/id</code>. This would work, but this reduces the accuracy of this name
semantics. <code>:hacker-news.item/author-name</code> has a precise meaning. It&#x27;s the author&#x27;s
name in an item.</p><p>To reconcile this situation, we can create an <a href="/docs/built-in-resolvers#aliasing">alias-resolver</a>,
that allows Pathom to navigate from one name to another. This is what I&#x27;m going to
use next.</p><p>It&#x27;s also good to point out that aliases are directional. We are allowing
<code>:hacker-news.item/author-name</code> to be translated in <code>:hacker-news.user/id</code>, but not
the reverse.</p></div></div><p>Let&#x27;s see who has the most karma from the front-page:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; update env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; {::durable-cache* cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (pci/register</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [; alias the author name to id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (pbir/alias-resolver :hacker-news.item/author-name :hacker-news.user/id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-html-string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data])))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt;&gt; (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           [:hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            :hacker-news.user/karma]}])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (sort-by :hacker-news.user/karma #(compare %2 %))))</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="read-comments"></a>Read comments<a aria-hidden="true" tabindex="-1" class="hash-link" href="#read-comments" title="Direct link to heading">#</a></h2><p>Let&#x27;s map the comments section:</p><div class="pathom-diagram"><p>  <img alt="Comments Page Mapping" src="/assets/images/comments-page-mapping-e0b023e3af3f972a5fd5e566a8739918.png"></p></div><p>We can see at the top we have almost the same data as we did on the news list, except
the rank position (which makes sense since it&#x27;s relative to that page).</p><p>Let&#x27;s start writing a resolver that can read this information given some item id:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; load page as hickory, use our durable cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver item-page-hickory [{:hacker-news.item/keys [id]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/cache-store ::durable-cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/item-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; (slurp (str &quot;https://news.ycombinator.com/item?id=&quot; id))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        hc/parse hc/as-hickory)})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver item-data [{:hacker-news.page/keys [item-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/url]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; let&#x27;s re-use our same extraction function, fatitem class is the container at</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; this page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (extract-item-from-hickory (-&gt;&gt; (hs/select (hs/class &quot;fatitem&quot;) item-hickory)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                  first)))</span></div></div></div></div></div><p>That&#x27;s easy enoughâ€”time for the comments.</p><p>By looking at the page we can see comments are nested, and altough this example isn&#x27;t
showing, they also support deep nesting.</p><p>Most of the time, the HTML will follow the structure of the data, but this isn&#x27;t the
case here.</p><p>Try inspecting the page. You will see they use a flat table and manually add the
spacings to convey the nesting.</p><p>This means we need to do more work to reconstruct the tree from a flat structure.</p><p>Let&#x27;s do that in parts. First, let&#x27;s extract it in a closer way to what we have: a flat structure. On top of the data I mentioned in the image, we now will
also add a <code>:hacker-news.comment/ident</code>, which tells us the row&#x27;s indentation level. Later I&#x27;ll use this to transform the list into a tree.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn comment-ident-level [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; (hs/select (hs/and (hs/tag &quot;img&quot;) (hs/attr &quot;src&quot; #{&quot;s.gif&quot;})) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      first :attrs :width select-number (/ 40)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn extract-comment [el]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.comment/id          (-&gt; el :attrs :id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.comment/age         (class-text el &quot;age&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.comment/author-name (class-text el &quot;hnuser&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.comment/indent      (comment-ident-level el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   :hacker-news.comment/content     (-&gt;&gt; (hs/select (hs/class &quot;comment&quot;) el)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         first :content (keep find-text) (str/join &quot;\n&quot;))})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver item-comments-flat [{:hacker-news.page/keys [item-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output [{:hacker-news.item/comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.comment/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.comment/content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.comment/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   :hacker-news.comment/indent]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.item/comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt;&gt; item-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (hs/select (hs/class &quot;comtr&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (mapv extract-comment))})</span></div></div></div></div></div><p>We can test that with (remember to add all resolvers to the env):</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; get all comments author names</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {:hacker-news.item/id &quot;25733200&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.item/comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.comment/author-name]}]))</span></div></div></div></div></div><p>Now it&#x27;s time to transform the list into a tree.</p><p>To think about this process, let&#x27;s use make up some example data and how it should be
transformed:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; first, visually, it looks like this:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; | 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; | 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; | 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; | | 6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; we have a list like this, with ids and indentations, the rest of the data we can ignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; for the purpose of this transformation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[{:id 1 :ident 0}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 2 :ident 1}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 3 :ident 1}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 4 :ident 0}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 5 :ident 1}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 6 :ident 2}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; and our goal is to transform that into:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[{:id 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  :children [{:id 2}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             {:id 3}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> {:id 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  :children [{:id 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              :children [{:id 6}]}]}]</span></div></div></div></div></div><p>To do this, we have to go over the list and remember past items. My idea to remember the
current level is: When it goes up, add an item to a stack. When it goes down, remove it from the
stack. The stack will contain the ids of the parent items. As I scan, I&#x27;ll also add
the items to a list, indexed by ID. This way, I can modify any item at any time with ease.</p><p>I decided it would be fun to use Pathom as part of this process too, and it&#x27;s nice the
things I discussed already feel like a graph.</p><p>This is the code:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver item-comments [{:hacker-news.item/keys [comments-flat]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.item/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.comment/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.comment/content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.comment/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {:hacker-news.comment/responses &#x27;...}]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (let [{:keys [roots index]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (-&gt;&gt; comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             (reduce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               (fn [{:keys [level prev] :as acc} {:hacker-news.comment/keys [id indent] :as comment}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 (let [{:keys [stack] :as acc} (cond-&gt; acc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                 (&gt; indent level)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                 (update :stack conj prev)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                 (&lt; indent level)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                 (update :stack pop))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       stack-head (peek stack)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   (cond-&gt; acc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (-&gt; (update :index assoc id comment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         (assoc :level indent)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         (assoc :prev id))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (zero? indent)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (update :roots conj comment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (pos? indent)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     (update-in [:index stack-head :hacker-news.comment/responses]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       coll/vconj {:hacker-news.comment/id id}))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               {:stack []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                :roots []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                :index {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                :level 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                :prev  nil}))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ; empty index when there are no comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (if (seq index)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ; use pathom to transform the query in a tree</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (-&gt;&gt; (p.eql/process</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             (pci/register [(pbir/static-table-resolver :hacker-news.comment/id index)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            (pbir/constantly-resolver :roots roots)])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             [{:roots [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       :hacker-news.comment/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       :hacker-news.comment/content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       :hacker-news.comment/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       {:hacker-news.comment/responses &#x27;...}]}])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :roots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           ; always remember to wrap the sequence in the named output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           (hash-map :hacker-news.item/comments))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {:hacker-news.item/comments []})))</span></div></div></div></div></div><p>Usage demo:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; lets recap what our env is like with all of the things</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; {::durable-cache* cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (pci/register</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [(pbir/alias-resolver :hacker-news.item/author-name :hacker-news.user/id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         ; add this new one to also alias from comment author name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (pbir/alias-resolver :hacker-news.comment/author-name :hacker-news.user/id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-html-string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         all-news-pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-comments])))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; the same we did before, but this time we will only see the top level comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {:hacker-news.item/id &quot;25733200&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.item/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.comment/author-name]}]))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; now, get the whole structured comments, and also include the karma of each user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; on it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {:hacker-news.item/id &quot;25733200&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.item/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.user/karma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {:hacker-news.comment/responses &#x27;...}]}]))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(comment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; WARNING: this will trigger a lot of requests, may take some time. Also, HN may</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ; throttle or block some accesses from you.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (p.eql/process env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [{:hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.item/url</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.user/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.user/karma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       :hacker-news.user/join-date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {:hacker-news.item/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.comment/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.comment/content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.comment/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.user/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.user/karma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         :hacker-news.user/join-date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         {:hacker-news.comment/responses &#x27;...}]}]}]))</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="playing-with-smart-maps"></a>Playing with Smart Maps<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playing-with-smart-maps" title="Direct link to heading">#</a></h2><p>Let&#x27;s do a pause on implementing HN things and play a bit with what we have.</p><p>In the previous examples we requested information using the <a href="/docs/eql">EQL interface</a>. The
EQL is the most efficient and precise way to use Pathom because in this way, Pathom
can look at a full-size request and optimize as much as possible.</p><p>I&#x27;ll now introduce <a href="/docs/smart-maps">Smart Maps</a> for our play here, which is a different interface to use
Pathom 3. Smart Maps are a data structure that works like Clojure maps, but when you
access some key that the map doesn&#x27;t know the value, it uses the Pathom resolvers to
figure out (when possible).</p><p>To this demo I&#x27;ll start with some item id and fetch some data:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(-&gt; (psm/smart-map env {:hacker-news.item/id &quot;25733200&quot;})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/title)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=&gt; &quot;OpenSocial Specification&quot;</span></div></div></div></div></div><p>Cool right?! You may be asking now: how do you know what is accessible?</p><p>To answer that you can leverage the <code>datafy</code> protocol implemented by Pathom Smart Maps:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(-&gt; (psm/smart-map env {:hacker-news.item/id &quot;25733200&quot;})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    clojure.datafy/datafy)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{:hacker-news.item/age :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/author-name :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/comments :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/comments-count :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/comments-flat :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/id &quot;25733200&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/score :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/source :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/title :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.item/url :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/item-hickory :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/news :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/news-all-pages :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/news-hickory :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/news-next-page :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/news-raw-html :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.page/user-hickory :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.user/id :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.user/join-date :com.wsscode.pathom3.connect.operation/unknown-value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> :hacker-news.user/karma :com.wsscode.pathom3.connect.operation/unknown-value}</span></div></div></div></div></div><p>There we can see many attributes related to the item (given we provided an item id). Also,
you can see all the pages, and some user data (because of the relationship from item to
the user).</p><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>The options offered by the Smart Map datafy are contextual. This means if you change
the data you may get different possible paths.</p></div></div><p>To some REPL play with it, here are some suggestions:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">; author karma from item 25733200</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(-&gt; (psm/smart-map env {:hacker-news.item/id &quot;25733200&quot;})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.user/karma)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">; author and content of first comment of the first post on news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(-&gt; (psm/smart-map env {})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.item/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (select-keys [:hacker-news.comment/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  :hacker-news.comment/content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  :hacker-news.user/join-date]))</span></div></div></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Value responses to smart maps are also smart maps. This is what allows the navigation
like you have seen before. This also means you can datafy at any point to see what paths
are available, for example:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(-&gt; (psm/smart-map env {})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    :hacker-news.page/news</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    clojure.datafy/datafy)</span></div></div></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="other-pages"></a>Other pages<a aria-hidden="true" tabindex="-1" class="hash-link" href="#other-pages" title="Direct link to heading">#</a></h2><p>So far, we extracted some details and the news page. Other pages like <code>past</code> and <code>ask</code>
are quite similar.</p><p>This is the list of resolvers we have to deal with on the news page:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">news-page-html-string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">news-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">news-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">all-news-pages</span></div></div></div></div></div><p>For the <code>past</code> page, I&#x27;ll simplify that, make the same resolver request the HTML and
parse it, as we did for comments and user details.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn extract-items-from-list [hickory]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (let [tbody (-&gt;&gt; hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   (hs/select (hs/class &quot;itemlist&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   (hs/select (hs/tag &quot;tbody&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   first)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tbody (update tbody :content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                #(into []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       (drop-while</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         (fn [e]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           (let [cls (some-&gt; e :attrs :class)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                             (not= cls &quot;athing&quot;))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       %))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (-&gt;&gt; tbody</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (hs/select (hs/and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      (hs/tag &quot;tr&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      (hs/not (hs/or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                (hs/class &quot;spacer&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                (hs/class &quot;morespace&quot;)))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (partition 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (mapv #(hash-map :type :element :tag :tbody :content (vec %)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (mapv extract-item-from-hickory))))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn extract-more-link [hickory]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (some-&gt;&gt; hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (hs/select (hs/class &quot;morelink&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    first :attrs :href))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver past-page-hickory [{:hacker-news.page/keys [past-page-url]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/cache-store ::durable-cache*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   ::pco/input       [(pco/? :hacker-news.page/past-page-url)]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/past-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (-&gt; (or past-page-url &quot;https://news.ycombinator.com/front&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       slurp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/parse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (hc/as-hickory))})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver past-page [{:hacker-news.page/keys [past-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/past</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      :hacker-news.item/url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {:hacker-news.page/past</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (extract-items-from-list past-hickory)})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(pco/defresolver past-next-page [{:hacker-news.page/keys [past-hickory]}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   [{:hacker-news.page/past-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     [:hacker-news.page/past-page-url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (if-let [link (extract-more-link past-hickory)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {:hacker-news.page/past-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     {:hacker-news.page/past-page-url</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (str &quot;https://news.ycombinator.com/&quot; link)}}))</span></div></div></div></div></div><p>If we compare with the news resolvers, they are almost the same. The differences are:</p><ul><li>The resolver names are different</li><li>The attribute names they are used for the collection node are different</li><li>The initial page uses a different URL</li><li>The table with items has some stuff before the actual first item. Our new implementation skips those.</li></ul><p>This similarity can make you feel like there is some higher-order thing to do here.
Especially when we consider that the <code>ask</code> page will be another instance of the same
situation.</p><p>We can generalize this by writing a function that returns some resolvers, let&#x27;s replace
our <code>past</code> page implementation with this idea:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(defn hn-page-resolvers [page-name base-url]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (let [hickory-sym   (symbol &quot;hacker-news.resolvers.page&quot; (str page-name &quot;-hickory&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        page-sym      (symbol &quot;hacker-news.resolvers.page&quot; page-name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        next-page-sym (symbol &quot;hacker-news.resolvers.page&quot; (str page-name &quot;-next-page&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        hickory-kw    (keyword &quot;hacker-news.page&quot; (str page-name &quot;-hickory&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        page-kw       (keyword &quot;hacker-news.page&quot; page-name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        next-page-kw  (keyword &quot;hacker-news.page&quot; (str page-name &quot;-next-page&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        page-url-kw   (keyword &quot;hacker-news.page&quot; (str page-name &quot;-page-url&quot;))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [(pco/resolver hickory-sym</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {::pco/cache-store ::durable-cache*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ::pco/input       [(pco/? page-url-kw)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ::pco/output      [hickory-kw]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (fn [_ input]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         {hickory-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (-&gt; (or (get input page-url-kw) base-url)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              slurp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              (hc/parse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              (hc/as-hickory))}))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     (pco/resolver page-sym</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {::pco/input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [hickory-kw]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [{page-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          [:hacker-news.item/age</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/author-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/comments-count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/score</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/rank-in-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           :hacker-news.item/url]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (fn [_ input]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         {page-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (extract-items-from-list (get input hickory-kw))}))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     (pco/resolver next-page-sym</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       {::pco/input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [hickory-kw]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ::pco/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [{next-page-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          [page-url-kw]}]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       (fn [_ input]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (if-let [link (extract-more-link (get input hickory-kw))]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           {next-page-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {page-url-kw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             (str &quot;https://news.ycombinator.com/&quot; link)}})))]))</span></div></div></div></div></div><p>Now we have a function that returns 3 resolvers in a vector. We can now use this to
define some pages:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-clojure codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(def env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (-&gt; {::durable-cache* cache*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      (pci/register</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [(pbir/alias-resolver :hacker-news.item/author-name :hacker-news.user/id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         (pbir/alias-resolver :hacker-news.comment/author-name :hacker-news.user/id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-html-string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         news-next-page</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         all-news-pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         ; this is different than news, news is the home, newest are the most recent</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         (hn-page-resolvers &quot;newest&quot; &quot;https://news.ycombinator.com/newest&quot;)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         (hn-page-resolvers &quot;past&quot; &quot;https://news.ycombinator.com/front&quot;)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         (hn-page-resolvers &quot;ask&quot; &quot;https://news.ycombinator.com/ask&quot;)</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">         (hn-page-resolvers &quot;show&quot; &quot;https://news.ycombinator.com/show&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         user-data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-page-hickory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-comments-flat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         item-comments])))</span></div></div></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p><code>pci/register</code> accepts nested vectors as definitions. It flattens the structure out
in the process of registration.</p></div></div><p>Just like that, we have four new pages implemented!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="review"></a>Review<a aria-hidden="true" tabindex="-1" class="hash-link" href="#review" title="Direct link to heading">#</a></h2><p>That&#x27;s it for this tutorial, a recap of what we saw here:</p><ul><li>Design attribute names for Hacker News data</li><li>Use Hickory to parse HTML data</li><li>Create resolvers to connect the system</li><li>Use recursive queries to traverse pagination</li><li>Use optional inputs</li><li>Use nested queries with recursive inputs</li><li>Smart Maps exploration</li><li>Creates resolvers dynamically using functions</li></ul><p>I hope you learned some new things about Pathom 3 in the process.</p><p>You can find the complete source code for this demo at: <a href="https://github.com/wilkerlucio/pathom3-docs/blob/master/src/main/com/wsscode/pathom3/docs/demos/tutorials/hacker_news_scrapper.clj" target="_blank" rel="noopener noreferrer">https://github.com/wilkerlucio/pathom3-docs/blob/master/src/main/com/wsscode/pathom3/docs/demos/tutorials/hacker_news_scrapper.clj</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="exercises"></a>Exercises<a aria-hidden="true" tabindex="-1" class="hash-link" href="#exercises" title="Direct link to heading">#</a></h2><p>If you like to keep playing, here are some suggestions to add:</p><ul><li>Parse comments back, linking back to the items they point to</li><li>Make relationships from the user to its submissions, comments, and favorites</li><li>Support logging in user and they use mutations to implement voting or submission of new entries</li><li>Replace the HTML parsing implementation with the <a href="https://github.com/HackerNews/API" target="_blank" rel="noopener noreferrer">Hacker News API</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/wilkerlucio/pathom3-docs/edit/master/docs/tutorials/hacker-news-scraper.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/shape-descriptor"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Shape Descriptor</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tutorials/serverless-pathom-gcf"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Serverless Pathom with GCF Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#attribute-mapping" class="table-of-contents__link">Attribute mapping</a></li><li><a href="#reading-the-news-page" class="table-of-contents__link">Reading the news page</a><ul><li><a href="#finding-the-items" class="table-of-contents__link">Finding the items</a></li><li><a href="#read-item-details" class="table-of-contents__link">Read item details</a></li></ul></li><li><a href="#make-a-resolver" class="table-of-contents__link">Make a resolver</a><ul><li><a href="#caching-the-request-for-development" class="table-of-contents__link">Caching the request for development</a></li></ul></li><li><a href="#traversing-pagination" class="table-of-contents__link">Traversing pagination</a></li><li><a href="#read-user-data" class="table-of-contents__link">Read user data</a></li><li><a href="#read-comments" class="table-of-contents__link">Read comments</a></li><li><a href="#playing-with-smart-maps" class="table-of-contents__link">Playing with Smart Maps</a></li><li><a href="#other-pages" class="table-of-contents__link">Other pages</a></li><li><a href="#review" class="table-of-contents__link">Review</a></li><li><a href="#exercises" class="table-of-contents__link">Exercises</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Presentations</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/watch?v=IS3i3DTUnAI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Conj 2019 - The Maximal Graph</a></li><li class="footer__item"><a href="https://www.youtube.com/watch?v=yyVKf2U8YVg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Conj 2018 - Scaling Full Stack Applications</a></li><li class="footer__item"><a href="https://www.youtube.com/watch?v=r3zywlNflJI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dutch Clojure Days 2018 - Clojure Graph APIâ€™s</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://clojurians.slack.com/messages/pathom/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Wilker Lucio</div></div></div></footer></div>
<script src="/styles.7bd4c1d1.js"></script>
<script src="/runtime~main.06d5458d.js"></script>
<script src="/main.b951b7af.js"></script>
<script src="/1.2e2774a7.js"></script>
<script src="/2.8a5fdb16.js"></script>
<script src="/3.c43cf402.js"></script>
<script src="/1be78505.9817f03c.js"></script>
<script src="/43.d6df2bea.js"></script>
<script src="/935f2afb.736e8c56.js"></script>
<script src="/17896441.01d25d16.js"></script>
<script src="/e6b7f731.69429666.js"></script>
</body>
</html>